name: Continuous Integration

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test-and-quality:
    name: Test & Quality Checks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Run quality checks
        run: npm run quality

      - name: Build application
        run: npm run build
        env:
          NODE_ENV: production

      - name: Run security audit
        run: npm audit --audit-level=moderate
        continue-on-error: ${{ github.event_name == 'push' }}

  # Only run this job for pull requests
  pr-quality-report:
    name: PR Quality Report
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --legacy-peer-deps

      - name: Generate quality report
        run: |
          echo "## ðŸ” Code Quality Report" >> quality-report.md
          echo "" >> quality-report.md

          echo "### ðŸ“Š Code Statistics" >> quality-report.md
          echo "\`\`\`" >> quality-report.md
          find app lib components -name "*.ts" -o -name "*.tsx" | wc -l | xargs echo "TypeScript files:"
          find app lib components -name "*.ts" -o -name "*.tsx" | xargs wc -l | tail -1
          echo "\`\`\`" >> quality-report.md
          echo "" >> quality-report.md

          echo "### ðŸš¨ Potential Issues" >> quality-report.md
          if grep -r --include="*.ts" --include="*.tsx" -n "console\." app/ lib/ components/ 2>/dev/null; then
            echo "âš ï¸ Found console statements - consider removing for production" >> quality-report.md
          else
            echo "âœ… No console statements found" >> quality-report.md
          fi

          if grep -r --include="*.ts" --include="*.tsx" -n "any\|unknown" app/ lib/ components/ 2>/dev/null | head -5; then
            echo "âš ï¸ Found 'any' or 'unknown' types - consider using more specific types" >> quality-report.md
          else
            echo "âœ… No problematic type usage found" >> quality-report.md
          fi

      - name: Comment PR
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request'
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('quality-report.md', 'utf8');

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: report
            });
